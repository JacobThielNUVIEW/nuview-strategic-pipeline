name: Daily Global Topographic Sweep
on:
  schedule: [{cron: '0 3 * * *'}]
  workflow_dispatch:

# Concurrency control: prevent multiple workflow runs from conflicting
concurrency:
  group: daily-ops-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  scrape:
    name: ðŸŒ Scrape Topographic Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.10'

      - name: ðŸ•·ï¸ Run Topographic Data Scraper
        run: |
          echo -e "\033[94mðŸŒ Starting topographic data collection...\033[0m"
          python scripts/scrapers/scrape_all.py
          echo -e "\033[92mâœ… Scraping completed successfully\033[0m"

      - name: ðŸ” Check for Data Changes
        id: check_changes
        run: |
          git add data/opportunities.json data/forecast.json
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo -e "\033[93mâš ï¸  No data changes detected\033[0m"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo -e "\033[94mâ„¹ï¸  Data changes detected\033[0m"
          fi

      - name: ðŸ“¦ Upload Scraped Data
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
        with:
          name: scraped-data
          path: |
            data/opportunities.json
            data/forecast.json
          retention-days: 7

  validate:
    name: âœ… QC Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: scrape
    if: needs.scrape.outputs.has_changes == 'true'
    outputs:
      qc_passed: ${{ steps.qc_validation.outputs.qc_passed }}
      qc_percentage: ${{ steps.qc_validation.outputs.qc_percentage }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v6

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: ðŸ Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Download Scraped Data
        uses: actions/download-artifact@v4
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427  # v4.1.4
        with:
          name: scraped-data
          path: data/

      - name: ðŸ”¬ Run QC Validation
        id: qc_validation
        run: |
          echo -e "\033[94mðŸ”¬ Running quality control validation...\033[0m"
          if python scripts/qc_validator.py; then
            echo "qc_passed=true" >> $GITHUB_OUTPUT
            echo "qc_percentage=100" >> $GITHUB_OUTPUT
            echo -e "\033[92mâœ… QC validation PASSED (100%)\033[0m"
          else
            echo "qc_passed=false" >> $GITHUB_OUTPUT
            echo "qc_percentage=0" >> $GITHUB_OUTPUT
            echo -e "\033[91mâŒ QC validation FAILED\033[0m"
            exit 1
          fi

      - name: ðŸ“Š Upload QC Report
        if: always()
        uses: actions/upload-artifact@v4
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
        with:
          name: qc-report
          path: data/processed/qc_report.json
          retention-days: 30

  merge:
    name: ðŸ”€ Merge Validated Data
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [scrape, validate]
    if: needs.validate.outputs.qc_passed == 'true'
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v6
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Download Validated Data
        uses: actions/download-artifact@v4
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427  # v4.1.4
        with:
          name: scraped-data
          path: data/

      - name: ðŸ“¦ Download QC Report
        uses: actions/download-artifact@v4
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427  # v4.1.4
        with:
          name: qc-report
          path: data/processed/

      - name: ðŸ”„ Generate Programs Data
        run: |
          echo -e "\033[94mðŸ”„ Generating programs.json from opportunities.json...\033[0m"
          if python scripts/generate_programs.py; then
            echo -e "\033[92mâœ… Programs data generated successfully\033[0m"
          else
            echo -e "\033[91mâŒ Failed to generate programs.json\033[0m"
            exit 1
          fi

      - name: ðŸ”€ Prepare Merge
        run: |
          echo -e "\033[94mðŸ”€ Preparing data merge...\033[0m"
          git config --local user.email "bot@nuview.space"
          git config --local user.name "NUVIEW Topographic Bot"
          git add data/opportunities.json data/forecast.json data/processed/qc_report.json data/processed/programs.json
          echo -e "\033[92mâœ… Merge preparation complete\033[0m"

      - name: ðŸ“¦ Upload Merge-Ready Data
        uses: actions/upload-artifact@v4
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
        with:
          name: merge-ready-data
          path: |
            data/opportunities.json
            data/forecast.json
            data/processed/qc_report.json
            data/processed/programs.json
          retention-days: 7

  push:
    name: ðŸš€ Push to Main
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [scrape, validate, merge]
    if: needs.validate.outputs.qc_passed == 'true' && needs.validate.outputs.qc_percentage == '100'
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v6
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Download Merge-Ready Data
        uses: actions/download-artifact@v4
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427  # v4.1.4
        with:
          name: merge-ready-data
          path: data/

      - name: ðŸš€ Commit and Push to Main (with retry and rebase)
        run: |
          echo -e "\033[94mðŸš€ Pushing validated topographic data to main...\033[0m"
          git config --local user.email "bot@nuview.space"
          git config --local user.name "NUVIEW Topographic Bot"
          
          git add data/opportunities.json data/forecast.json data/processed/qc_report.json data/processed/programs.json
          
          if git diff --staged --quiet; then
            echo -e "\033[93mâš ï¸  No changes to commit\033[0m"
            exit 0
          fi
          
          git commit -m "Daily Global Topographic Sweep Update - QC Passed (100%)"
          
          # Smart sync with retry: pull and rebase before push
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo -e "\033[94mâ„¹ï¸  Attempting to pull and rebase (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)...\033[0m"
            
            if git pull --rebase origin main; then
              echo -e "\033[92mâœ… Successfully rebased with remote changes\033[0m"
              
              if git push origin main; then
                echo -e "\033[92mâœ… Successfully pushed to main branch\033[0m"
                echo -e "\033[94mâ„¹ï¸  Dashboard will auto-update via deploy-pages workflow\033[0m"
                exit 0
              else
                echo -e "\033[93mâš ï¸  Push failed, retrying...\033[0m"
              fi
            else
              echo -e "\033[93mâš ï¸  Rebase failed, retrying...\033[0m"
              git rebase --abort 2>/dev/null || true
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo -e "\033[94mâ„¹ï¸  Waiting 10 seconds before retry...\033[0m"
              sleep 10
            fi
          done
          
          echo -e "\033[91mâŒ Failed to push after $MAX_RETRIES attempts\033[0m"
          exit 1
      
      - name: ðŸ“Š Create Success Notification
        uses: actions/github-script@v7
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            const timestamp = new Date().toISOString();
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const dashboardUrl = `https://salesnuviewspace.netlify.app`;
            
            const body = `## âœ… Daily Global Topographic Sweep - Success
            
            **Status:** âœ… COMPLETED
            **Time:** ${timestamp}
            **Workflow Run:** [View Run](${runUrl})
            **Dashboard:** [View Dashboard](${dashboardUrl})
            
            ### Summary
            - Data scraped successfully
            - QC validation passed (100%)
            - Programs data auto-generated for dashboard
            - Changes pushed to main branch
            - Dashboard updates automatically on Netlify and GitHub Pages
            
            ---
            ðŸ¤– Automated notification from Daily Global Topographic Sweep workflow`;
            
            // Try to find an existing success notification issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'daily-update',
              per_page: 1
            });
            
            if (issues.data.length > 0) {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            }

  notify:
    name: ðŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [scrape, validate]
    if: always() && needs.scrape.outputs.has_changes == 'true' && needs.validate.outputs.qc_passed == 'false'
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v6

      - name: ðŸ“¦ Download QC Report
        uses: actions/download-artifact@v4
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: ðŸ“¦ Download QC Report
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427  # v4.1.4
        with:
          name: qc-report
          path: data/processed/
        continue-on-error: true

      - name: ðŸ“Š Parse QC Report
        id: parse_report
        run: |
          if [ -f "data/processed/qc_report.json" ]; then
            QC_SUMMARY=$(python3 -c "import json; data=json.load(open('data/processed/qc_report.json')); print(data.get('summary', 'QC validation failed'))")
            TOTAL_ERRORS=$(python3 -c "import json; data=json.load(open('data/processed/qc_report.json')); print(data.get('total_errors', 'unknown'))")
            TOTAL_WARNINGS=$(python3 -c "import json; data=json.load(open('data/processed/qc_report.json')); print(data.get('total_warnings', 'unknown'))")
            echo "summary=${QC_SUMMARY}" >> $GITHUB_OUTPUT
            echo "errors=${TOTAL_ERRORS}" >> $GITHUB_OUTPUT
            echo "warnings=${TOTAL_WARNINGS}" >> $GITHUB_OUTPUT
          else
            echo "summary=QC report not available" >> $GITHUB_OUTPUT
            echo "errors=unknown" >> $GITHUB_OUTPUT
            echo "warnings=unknown" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¢ Create GitHub Issue Comment
        uses: actions/github-script@v7
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            const summary = "${{ steps.parse_report.outputs.summary }}";
            const errors = "${{ steps.parse_report.outputs.errors }}";
            const warnings = "${{ steps.parse_report.outputs.warnings }}";
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            const body = `## ðŸš¨ Daily Global Topographic Sweep - QC Validation Failed
            
            **Status:** âŒ FAILED
            **Errors:** ${errors}
            **Warnings:** ${warnings}
            
            **Summary:** ${summary}
            
            **Action Required:** Review the [workflow run](${runUrl}) and QC report artifact for details.
            
            ---
            ðŸ¤– Automated notification from Daily Global Topographic Sweep workflow`;
            
            // Try to find an existing open issue for QC failures
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'qc-failure',
              per_page: 1
            });
            
            if (issues.data.length > 0) {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
              console.log(`Comment added to issue #${issues.data[0].number}`);
            } else {
              // Create a new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Daily Global Topographic Sweep QC Validation Failed',
                body: body,
                labels: ['qc-failure', 'automated']
              });
              console.log('New QC failure issue created');
            }

      - name: ðŸ“± Slack Notification (Optional)
        if: vars.SLACK_WEBHOOK_URL != ''
        run: |
          SUMMARY="${{ steps.parse_report.outputs.summary }}"
          ERRORS="${{ steps.parse_report.outputs.errors }}"
          WARNINGS="${{ steps.parse_report.outputs.warnings }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          PAYLOAD=$(cat <<EOF
          {
            "text": "ðŸš¨ Daily Global Topographic Sweep - QC Validation Failed",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ðŸš¨ QC Validation Failed"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\nâŒ FAILED"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Errors:*\n${ERRORS}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Warnings:*\n${WARNINGS}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Summary:* ${SUMMARY}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow Run"
                    },
                    "url": "${RUN_URL}"
                  }
                ]
              }
            ]
          }
          EOF
          )
          
          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "${{ vars.SLACK_WEBHOOK_URL }}"
          echo -e "\033[92mâœ… Slack notification sent\033[0m"
